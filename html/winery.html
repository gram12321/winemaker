<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game Page - Winery</title>
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link href="/css/style.css" rel="stylesheet" />
  </head>
  <body>
    <div class="d-flex" id="wrapper">
      <!-- Sidebar -->
      <div id="sidebar-wrapper"></div>

      <!-- Main Content -->
      <div class="container text-center flex-grow-1" id="page-content-wrapper">
        <h1>Winery</h1>

        <!-- Winery Processes -->
        <div class="accordion" id="wineryProcesses">
          <!-- Crushing Grapes -->
          <div class="card">
            <div class="card-header" id="headingCrush">
              <h2 class="mb-0">
                <button
                  class="btn btn-link"
                  data-toggle="collapse"
                  data-target="#collapseCrush"
                >
                  Crushing Grapes
                </button>
              </h2>
            </div>
            <div
              id="collapseCrush"
              class="collapse show"
              data-parent="#wineryProcesses"
            >
              <div class="card-body d-flex">
                <!-- Player Inventory Section -->
                <div class="pr-4">
                  <h4>Grapes in Inventory</h4>
                  <ul class="list-group" id="crush-inventory-list">
                    <!-- Inventory items will be populated here dynamically -->
                  </ul>
                </div>
                <!-- Crushing Content Section -->
                <div class="flex-grow-1">
                  <h4>Crushing</h4>
                  <select class="form-control mb-2" id="crush-resource-select">
                    <!-- Options will be populated dynamically -->
                  </select>
                  <button class="btn btn-primary mb-2" id="crush-grapes-btn">
                    Start Crushing
                  </button>
                </div>
                <!-- Add Image Section for Crushing -->
                <div>
                  <img
                    src="../assets/pic/crushing_dalle.webp"
                    alt="Crushing Process Image"
                    class="process-image"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- Fermentation -->
          <div class="card">
            <div class="card-header" id="headingFermentation">
              <h2 class="mb-0">
                <button
                  class="btn btn-link collapsed"
                  data-toggle="collapse"
                  data-target="#collapseFermentation"
                >
                  Fermentation
                </button>
              </h2>
            </div>
            <div
              id="collapseFermentation"
              class="collapse"
              data-parent="#wineryProcesses"
            >
              <div class="card-body d-flex">
                <!-- Must Inventory Section -->
                <div class="pr-4" style="min-width: 200px">
                  <h4>Must in Inventory</h4>
                  <ul class="list-group" id="fermentation-inventory-list">
                    <!-- Must items will be populated here dynamically -->
                  </ul>
                </div>

                <!-- Fermentation Content Section -->
                <div class="flex-grow-1">
                  <h4>Fermenting</h4>
                  <select
                    class="form-control mb-2"
                    id="ferment-resource-select"
                  >
                    <!-- Options will be populated dynamically -->
                  </select>
                  <button class="btn btn-primary mb-2" id="fermentation-btn">
                    Start Fermentation
                  </button>
                </div>
                <!-- Add Image Section for Fermentation -->
                <div>
                  <img
                    src="../assets/pic/fermentation_dalle.webp"
                    alt="Fermentation Process Image"
                    class="process-image"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="/js/loadPanel.js"></script>

    <!-- Custom JavaScript -->
    <script type="module">
      import { addConsoleMessage } from "/js/console.js";
      import { inventoryInstance } from "/js/resource.js";
      import { grapeCrushing, fermentMust, handleGrapeCrushingTask, handleFermentationTask } from "/js/wineprocessing.js";
      import { Task } from "/js/loadPanel.js";
      import { loadTasks, saveTask, activeTasks } from "/js/database/adminFunctions.js";
      import { initializeSidebar } from "/js/database/loadSidebar.js";
      import { initializePanel } from "/js/loadPanel.js";
      import { initializeConsole } from "/js/console.js";
      import { formatNumber, getWineQualityCategory, getColorClass } from "/js/utils.js";

      document.addEventListener("DOMContentLoaded", function () {
        initializePanel();
        initializeSidebar();
        initializeConsole();

        populateCrushInventoryList();
        populateFermentationInventoryList();
        populateResourceSelect();
        populateFermentResourceSelect();

        function populateCrushInventoryList() {
          const crushInventoryList = document.getElementById("crush-inventory-list");
          crushInventoryList.innerHTML = "";

          inventoryInstance.items.forEach((item) => {
            if (item.state === "Grapes") {
              const colorClass = getColorClass(item.quality);
              const listItem = document.createElement("li");
              listItem.className = 'list-group-item';

              listItem.innerHTML = `
                <strong>${item.fieldName}</strong>, 
                ${item.resource.name}, 
                ${item.vintage}, 
                <span class="${colorClass}">(${(item.quality * 100).toFixed(0)}%)</span>, 
                ${formatNumber(item.amount)}t`;

              crushInventoryList.appendChild(listItem);
            }
          });
        }

        function populateFermentationInventoryList() {
          const fermentationList = document.getElementById("fermentation-inventory-list");
          fermentationList.innerHTML = "";

          inventoryInstance.items.forEach((item) => {
            if (item.state === "Must") {
              const colorClass = getColorClass(item.quality);
              const listItem = document.createElement("li");
              listItem.className = 'list-group-item';

              listItem.innerHTML = `
                <strong>${item.fieldName}</strong>, 
                ${item.resource.name} must, 
                ${item.vintage}, 
                <span class="${colorClass}">(${(item.quality * 100).toFixed(0)}%)</span>, 
                ${formatNumber(item.amount)}l`;

              fermentationList.appendChild(listItem);
            }
          });
        }

        function populateResourceSelect() {
          const selectElement = document.getElementById("crush-resource-select");
          selectElement.innerHTML = "";

          inventoryInstance.items.forEach((item) => {
            if (item.state === "Grapes") {
              const colorClass = getColorClass(item.quality);
              const option = document.createElement("option");
              option.value = item.resource.name;

              option.innerHTML = `
                <strong>${item.fieldName}</strong>, 
                ${item.resource.name}, 
                ${item.vintage}, 
                <span class="${colorClass}">(${(item.quality * 100).toFixed(0)}%)</span>, 
                ${formatNumber(item.amount)}t`;

              selectElement.appendChild(option);
            }
          });
        }

        function populateFermentResourceSelect() {
          const selectElement = document.getElementById("ferment-resource-select");
          selectElement.innerHTML = "";

          inventoryInstance.items.forEach((item) => {
            if (item.state === "Must") {
              const colorClass = getColorClass(item.quality);
              const option = document.createElement("option");
              option.value = item.resource.name;

              option.innerHTML = `
                <strong>${item.fieldName}</strong>, 
                ${item.resource.name} must, 
                ${item.vintage}, 
                <span class="${colorClass}">(${(item.quality * 100).toFixed(0)}%)</span>, 
                ${formatNumber(item.amount)}l`;

              selectElement.appendChild(option);
            }
          });
        }

        // Grape Crushing Task Button Listener
        document.getElementById("crush-grapes-btn").addEventListener("click", function () {
          const selectedResource = document.getElementById("crush-resource-select").value;
          if (selectedResource) {
            handleGrapeCrushingTask(selectedResource);
          } else {
            addConsoleMessage("No resource selected for crushing.");
          }
        });

        // Fermentation Task Button Listener
        document.getElementById("fermentation-btn").addEventListener("click", function () {
          const selectedResource = document.getElementById("ferment-resource-select").value;
          if (selectedResource) {
            handleFermentationTask(selectedResource);
          } else {
            addConsoleMessage("No resource selected for fermentation.");
          }
        });
      });
    </script>
  </body>
</html>