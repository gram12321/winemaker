<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game Page - Inventory</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/style.css" rel="stylesheet">
</head>
<body>
  <div class="d-flex" id="wrapper">
    <!-- Sidebar -->
    <div id="sidebar-wrapper">
    </div>

    <!-- Main Content -->
    <div class="container text-center flex-grow-1" id="page-content-wrapper">
      <h1>Inventory</h1>

      <!-- Storage Section -->
      <section class="my-4">
        <h3>Storage</h3>
        <table class="table table-bordered">
          <thead>
              <tr>
                  <th>Container</th>
                  <th>Capacity</th>
                  <th>Resource</th>
                  <th>Amount</th>
                  <th>Quality</th> <!-- New Quality Column -->
                  <th>Status</th>
              </tr>
          </thead>
          <tbody id="storage-table-body">
            <!-- Storage resources will be dynamically generated here -->
          </tbody>
        </table>
      </section>

      <!-- Warehouse Inventory -->
      <section class="my-4">
        <h3>Warehouse</h3>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Resource</th>
              <th>Amount</th>
              <th>Quality</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="warehouse-table-body">
            <!-- Warehouse resources will be dynamically generated here -->
          </tbody>
        </table>
      </section>

      <!-- Fermentation Tanks Inventory -->
      <section class="my-4">
        <h3>Fermentation Tanks</h3>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Resource</th>
              <th>Amount</th>
              <th>Quality</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="fermentation-table-body">
            <!-- Fermentation Tanks resources will be dynamically generated here -->
          </tbody>
        </table>
      </section>

      <!-- Wine Cellar Inventory -->
      <section class="my-4">
        <h3>Wine Cellar</h3>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Resource</th>
              <th>Amount</th>
              <th>Quality</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="winecellar-table-body">
            <!-- Wine Cellar resources will be dynamically generated here -->
          </tbody>
        </table>
      </section>
    </div>
  </div>

  <!-- Properly order JS dependencies -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script type="module" src="/js/loadPanel.js"></script>
  <script type="module" src="/js/database/loadSidebar.js"></script>

  <script type="module">
      import { inventoryInstance, displayInventory } from '/js/resource.js'; // Ensure proper import
      import { initializeSidebar } from '/js/database/loadSidebar.js';
      import { initializePanel } from '/js/loadPanel.js';
      import { initializeConsole } from '/js/console.js'; // Import the console initializer
    import { formatNumber, getWineQualityCategory, getColorClass  } from '/js/utils.js';

      document.addEventListener('DOMContentLoaded', function () {
        initializePanel();
        initializeSidebar();
        initializeConsole();

        // Populate storage table
        populateStorageTable();

        // Show the inventory
        displayInventory(inventoryInstance);
      });
    document.addEventListener('DOMContentLoaded', function () {
      populateStorageTable(); // Call to populate the storage table
    });

    function populateStorageTable() {
      // Get the table body for storage
      const storageTableBody = document.getElementById('storage-table-body');

      // Load buildings and player inventory from local storage
      const buildings = JSON.parse(localStorage.getItem('buildings')) || [];
      const playerInventory = JSON.parse(localStorage.getItem('playerInventory')) || [];

      // Clear existing table content
      storageTableBody.innerHTML = '';

      buildings.forEach((building) => {
        // Iterate through contents of each building (assumed to be tools)
        building.contents.forEach((tool) => {
          // Check if the tool has a capacity greater than 0
          if (tool.capacity > 0) {
            const row = document.createElement('tr');

            const containerCell = document.createElement('td');
            containerCell.textContent = tool.name; // Using tool.name as container

            const capacityCell = document.createElement('td');
            capacityCell.textContent = tool.capacity;

            const matchingInventoryItems = playerInventory.filter(item => item.storage === tool.name);
            const amountCell = document.createElement('td');

            // Calculate total amount and append "t"
            const totalAmount = matchingInventoryItems.reduce((sum, item) => sum + item.amount, 0) || 0;
            amountCell.textContent = `${formatNumber(totalAmount)} t`;

            const resourceCell = document.createElement('td');
            // Use first matched item's details for display, or 'N/A' if no matches are found
            if (matchingInventoryItems.length > 0) {
              const { resource, state, vintage, fieldName } = matchingInventoryItems[0];
              resourceCell.innerHTML = `<strong>${fieldName}</strong>, ${resource.name}, ${vintage || 'Unknown'}`;
            } else {
              resourceCell.textContent = 'N/A';
            }

            const qualityCell = document.createElement('td');
            // Show quality of resource if available or 'N/A'
            if (matchingInventoryItems.length > 0) {
              const { quality } = matchingInventoryItems[0];
              const qualityDescription = getWineQualityCategory(quality);
              const colorClass = getColorClass(quality);
              qualityCell.innerHTML = `${qualityDescription} <span class="${colorClass}">(${quality.toFixed(2)})</span>`;
            } else {
              qualityCell.textContent = 'N/A'; 
            }

            const statusCell = document.createElement('td');
            // Use status icon based on the state of the first inventory item
            if (matchingInventoryItems.length > 0) {
              const statusIconPath = `/assets/pic/${matchingInventoryItems[0].state.toLowerCase()}_dalle.webp`;
              statusCell.innerHTML = `<img src="${statusIconPath}" alt="${matchingInventoryItems[0].state}" class="status-image">`;
            } else {
              statusCell.textContent = 'N/A'; // Or an appropriate default
            }

            // Append cells to the row
            row.appendChild(containerCell);
            row.appendChild(capacityCell);
            row.appendChild(resourceCell);
            row.appendChild(amountCell);
            row.appendChild(qualityCell);
            row.appendChild(statusCell);

            // Append the row to the table body
            storageTableBody.appendChild(row);
          }
        });
      });
    }
  </script>
</body>
</html>